define(["require","exports","Html","wsdl"],function(e,n,t,r){var o=function(){function e(){}return e.prototype.queryCurrentTab=function(){return new Promise(function(e,n){var t={active:!0,currentWindow:!0};chrome.tabs.query(t,function(t){return 1==t.length?e(t[0]):n(new Error("Failed to query current tab."))})})},e.prototype.sendMessageToTab=function(e,n){return new Promise(function(t,r){chrome.tabs.sendMessage(e,n,function(e){return 1==arguments.length?t(e):r(chrome.runtime.lastError)})})},e.prototype.downloadFile=function(e,n){var t=this;if(chrome.tabs){var r={command:"download",name:e,data:n};this.queryCurrentTab().then(function(e){return t.sendMessageToTab(e.id,r)})}else{var o=document.createElement("a");o.download=e,o.href=n;var a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0),o.dispatchEvent(a)}},e.prototype.getWsdl=function(){var e=this;return new Promise(function(n,t){if(chrome.tabs){var r={command:"getXml"};return e.queryCurrentTab().then(function(n){return e.sendMessageToTab(n.id,r)}).then(function(e){return n(e)})["catch"](function(e){return t(e)})}var o=new XMLHttpRequest;o.open("GET",e.url),o.onload=function(e){return n(o.responseText)},o.onerror=function(n){return t(new Error("Failed to load data from url: "+e.url))},o.send()})},e.prototype.getUrl=function(){return chrome.tabs?this.queryCurrentTab().then(function(e){return e.url}):Promise.resolve(this.url)},e.prototype.getFilenameFromUrl=function(e,n){var t=e.substring(e.lastIndexOf("/")+1).replace(/[^a-z0-9\-\.]/gi,"_");return n&&t.substr(-n.length)!=n&&(t+=n),t},e.prototype.address=function(e,n){for(var t=n,r=1;e.hasOwnProperty(n);)n=t+" ("+ ++r+")";return e[n]=!0,"#/"+n},e.prototype.sort=function(e){return e.sort(function(e,n){return e.name.localName.localeCompare(n.name.localName)}),e},e.prototype.createTree=function(e){var n=this,r={};document.getElementById("tree").insertAdjacentHTML("beforeEnd",['<ul class="collapsible">',this.sort(e.services).map(function(o){return['<li class="expanded">',"<span>",'<a id="wsdl"',' href="',t.encode(n.address(r,"download")),'"',' data-ctx="',t.encode(JSON.stringify({service:o.name.localName})),'"','">',t.encode(o.name.localName),"</a>","</span>",'<ul class="collapsible">',n.sort(o.ports).map(function(a){var i=e.bindings[String(a.binding)];return['<li class="expanded">','<span title="',t.encode(a.description),'">',t.encode(a.name.localName),"</span>",i?['<ul class="operations">',n.sort(i.operations).map(function(s){var l=e.portTypes[String(i.type)],c=l?l.operations[String(s.name)]:null,u=n.address(r,[o.name.localName,a.name.localName,s.name.localName].join("/"));return["<li>","<a",' href="',t.encode(u),'""',' title="',t.encode(s.description||(c?c.description:"")),'""',' data-ctx="',t.encode(JSON.stringify({address:u,operation:s.name.localName})),'">',t.encode(s.name.localName),"</a>","</li>"].join("")}).join(""),"</ul>"].join(""):"","</li>"].join("")}).join(""),"</ul>","</li>"].join("")}).join(""),"</ul>"].join(""))},e.prototype.list_OnClick=function(e){var n=this;e.preventDefault();var t=e.target,r=t.parentElement;"SPAN"==t.tagName&&"LI"==r.tagName?r.classList.contains("collapsed")?(r.classList.add("expanded"),r.classList.remove("collapsed")):r.classList.contains("expanded")&&(r.classList.add("collapsed"),r.classList.remove("expanded")):"A"==t.tagName&&this.getUrl().then(function(e){return n.wsd._parseSchema(e)}).then(function(e){if("wsdl"==t.id){var r=n.wsd.url,o=n.getFilenameFromUrl(r,".zip");if(n.zip)return void n.downloadFile(o,n.zip);var a={},i=new JSZip;i.file(n.generateFilename(a,r,".wsdl"),n.wsd.text||"");var s=Promise.resolve(null);n.wsd.imports.forEach(function(e){return s=s.then(function(t){return n.wsd._ajax[e.location]}).then(function(t){return i.file(n.generateFilename(a,e.location,".wsdl"),t||"")})}),s=s.then(function(e){n.zip="data:application/zip;base64,"+i.generate(),n.downloadFile(o,n.zip)})}else{var l=JSON.parse(t.dataset.ctx),c={};for(var u in n.wsd.resources)c[u]=n.wsd.resources[u].value();var d={command:"openEditor",title:l.operation,address:l.address,url:n.wsd.url,resources:c};if(!chrome.runtime)return void console.log(d);chrome.runtime.sendMessage(d)}})},e.prototype.generateFilename=function(e,n,t){for(var r=0,o=this.getFilenameFromUrl(n)||"file";e.hasOwnProperty(o+t);)o=o+"."+ ++r;return e[o+t]=!0,o+t},e.prototype.loading=function(e){var n=document.getElementById("loading");!n&&e?this.main.insertAdjacentHTML("beforeEnd",'<div id="loading">Loading&hellip;</div>'):n&&!e&&n.remove()},e.prototype.error=function(e){console.error(e),this.main.insertAdjacentHTML("beforeEnd",'<div class="error">'+t.encode(e.message||String(e))+"</div>")},e.prototype.run=function(){var e=this;this.main=document.getElementById("main");var n=document.getElementById("tree");n.onclick=function(n){return e.list_OnClick(n)},this.main.insertAdjacentHTML("afterBegin",['<div id="version">v',t.encode(chrome.runtime.getManifest().version),"</div>"].join(""));var o=setTimeout(function(n){o=null,e.loading(!0)},50);return Promise.resolve(null).then(function(n){return e.getUrl()}).then(function(n){return e.url=n}).then(function(n){return e.getWsdl()}).then(function(n){return r.WsdlDocument.parse(e.url,n,!1,null)}).then(function(n){return e.createTree(e.wsd=n)})["catch"](function(n){return e.error(n)})["finally"](function(){o?clearTimeout(o):e.loading(!1)})},e}();(new o).run()});