define(["require","exports","vkbeautify","xml"],function(e,t,r,n){t.NS={soap:"http://schemas.xmlsoap.org/wsdl/soap/",soap12:"http://schemas.xmlsoap.org/wsdl/soap12/",soapEnv:"http://schemas.xmlsoap.org/soap/envelope/",soap12Env:"http://www.w3.org/2003/05/soap-envelope",http:"http://schemas.xmlsoap.org/wsdl/http/",wsdl:"http://schemas.xmlsoap.org/wsdl/",schema:"http://www.w3.org/2001/XMLSchema"};var o=function(){function e(){}return e}();t.WsdlService=o;var a=function(){function e(){}return e}();t.WsdlMessage=a;var s=function(){function e(){}return e}();t.WsdlMessagePart=s;var i=function(){function e(){}return e}();t.WsdlPort=i;var p=function(){function e(){}return e}();t.WsdlPortAddress=p;var u=function(){function e(){}return e}();t.WsdlPortType=u;var c=function(){function e(){}return e}();t.WsdlPortTypeOperation=c;var l=function(){function e(){}return e}();t.WsdlBinding=l;var m=function(){function e(){}return e}();t.WsdlBindingOperation=m;var h=function(){function e(){}return e}();t.XsdDocument=h;var d=function(){function e(e,t){this._parsed=!1,this._loaded=!1,this.generator=null,this.url=e,this.text=t,this.messages={},this.portTypes={},this.bindings={},this.services=[],this.schemas=[],this.imports=[],this.resources={},this.resources[e]=Promise.resolve(t)}return e.getDirectory=function(e){return e.substr(0,e.lastIndexOf("/"))},e.combineUrl=function(e,t){if(/^(?:https?|file):\/\//.test(t))return t;for(var r=e.split("/"),n=t.split("/"),o=[],a=0,s=r.length;s>a;++a)if(".."==r[a])o.pop();else{if("."==r[a])continue;o.push(r[a])}for(var a=0,s=n.length;s>a;++a)if(".."==n[a])o.pop();else{if("."==n[a])continue;o.push(n[a])}return o.join("/")},e.parse=function(t,r,n,o){var a=new e(t,r),s=Promise.resolve(a).then(function(e){return a.parse(t)});return s=n?s.then(function(e){return a._parseSchema(t)}).then(function(e){return a}):s.then(function(e){return a._loaded=!0}).then(function(e){return a})},e._generateSoapMessage=function(e,r){var n=t.NS[r+"Env"],o=document.implementation.createDocument(n,"Envelope",null),a=e.operation.input[r].headers;if(a.length){var s=o.createElementNS(n,"Header");o.documentElement.appendChild(s);for(var i=0,p=a.length;p>i;++i)for(var u=a[i],c=e.wsdl.messages[u.message],l=0,m=c.parts.length;m>l;++l){var h=c.parts[l];if(h.name==u.parts){for(var d=e.wsdl.generator.writeXml(h.element),f=0;f<d.childNodes.length;++f)s.appendChild(o.importNode(d.childNodes[f],!0));break}}}var c=e.wsdl.messages[String(e.portTypeOperation.input)],v=o.createElementNS(n,"Body");o.documentElement.appendChild(v);var g=e.operation.input[r].body,y=e.operation[r].style||e.binding[r].style;if("rpc"==y){var S=o.createElementNS(e.operation.name.namespace,e.operation.name.localName);v.appendChild(S),c.parts.forEach(function(t){var r=o.createElementNS(e.operation.name.namespace,t.name);S.appendChild(r),r.appendChild(document.createTextNode("["+t.type.localName+"]"))})}else{g.parts||(g.parts=c.parts[0].name);for(var i=0,p=c.parts.length;p>i;++i){var h=c.parts[i];if(h.name==g.parts){for(var d=e.wsdl.generator.writeXml(h.element),f=0;f<d.childNodes.length;++f)v.appendChild(o.importNode(d.childNodes[f],!0));break}}}return o},e.generateRequest=function(t){var r={method:"POST",url:"",headers:{},body:""};if(t.operation&&t.operation.input)if(t.operation.soap12){r.url=t.port.soap12.address,t.operation.soap12.hasOwnProperty("action")&&(r.headers.SOAPAction='"'+t.operation.soap12.action+'"',r.headers["Content-Type"]='application/soap+xml; charset="utf-8"');try{r.body=e.format.xml(e._generateSoapMessage(t,"soap12"))}catch(n){console.error(n),r.body=n.message}}else if(t.operation.soap){r.url=t.port.soap.address,t.operation.soap.hasOwnProperty("action")&&(r.headers.SOAPAction='"'+t.operation.soap.action+'"',r.headers["Content-Type"]='text/xml; charset="utf-8"');try{r.body=e.format.xml(e._generateSoapMessage(t,"soap"))}catch(n){console.error(n),r.body=n.message}}else t.operation.http&&(r.method=t.binding.http.verb,r.url=t.port.http.address+t.operation.http.location);return r},e._children=function(e,t,r){for(var n=e.childNodes,o=[],a=0,s=n.length;s>a;++a){var i=n[a];1==i.nodeType&&i.namespaceURI==t&&i.localName==r&&o.push(i)}return o},e._child=function(t,r,n){return e._children(t,r,n)[0]},e.prototype._ajax=function(e){var t=this.resources;return t.hasOwnProperty(e)?t[e]:t[e]=new Promise(function(t,r){var n=new XMLHttpRequest;n.open("GET",e),n.onload=function(e){return t(n.responseText)},n.onerror=function(t){return r(new Error("Failed to load data from url: "+e))},n.send()})},e.prototype._resolveImport=function(t,r,n){if(!r)throw new Error("Missing location.");var o=e.combineUrl(t,r);return this._ajax(o).then(function(e){return{location:o,ns:n,text:e,XML:(new DOMParser).parseFromString(e,"text/xml")}})},e.prototype._resolveImports=function(e,t){var r=this,n=[];return t.length?Promise.resolve(t).map(function(t){var o=t.getAttributeNS(null,"schemaLocation");if(o){var a=t.getAttributeNS(null,"namespace");return r._resolveImport(e,o,a).then(function(e){return n.push(e)})}},{concurrency:1}).then(function(e){return n}):Promise.resolve(n)},e.prototype.resolveImport=function(r,o){var a=this,s=[],o=e.getDirectory(o);return Promise.resolve(r.children("import",t.NS.schema)).map(function(t){var r=t.attr("schemaLocation"),i=t.attr("namespace");return r?(r=e.combineUrl(o,r),a._ajax(r).then(function(e){return{location:r,ns:i,text:e,XML:n.Xml.fromString(e)}}).then(function(e){return s.push(e),a.resolveImport(e.XML,e.location)}).then(function(e){return Array.prototype.push.apply(s,e)})):void 0}).then(function(e){return r.children("include",t.NS.schema)}).map(function(t){var r=t.attr("schemaLocation"),i=t.attr("namespace");return r?(r=e.combineUrl(o,r),a._ajax(r).then(function(e){return{location:r,ns:i,text:e,XML:n.Xml.fromString(e)}}).then(function(e){return s.push(e),a.resolveImport(e.XML,e.location)}).then(function(e){return Array.prototype.push.apply(s,e)})):void 0}).then(function(e){return s})},e.prototype._parseSchema=function(e){var t=this;return this._loaded?Promise.resolve(this):(this._loaded=!0,Promise.resolve(this.schemas).map(function(e){return t.resolveImport(e,t.url)},{concurrency:1}).then(function(e){return e=Array.prototype.concat.apply([],e),new Promise(function(r,n){requirejs(["xmlSampleGenerator"],function(n){t.generator=new n.XmlSampleGenerator(t.targetNamespace,t.schemas,e),r(t.generator)})})}).then(function(e){return t}))},e.prototype._parseSoapInputOrOutput=function(e,t){var r={body:null,headers:new Array},n=e.child("body",t);return n&&(r.body={parts:n.attr("parts"),use:n.attr("use"),encodingStyle:n.attr("encodingStyle"),namespace:n.attr("namespace")}),e.children("header",t).forEach(function(e){var o={message:e.resolveNS(e.attr("message")),parts:e.attr("part"),use:n.attr("use"),encodingStyle:n.attr("encodingStyle"),namespace:n.attr("namespace"),faults:[]};e.children("headerfault",t).forEach(function(e){var t={message:e.attr("message"),parts:e.attr("part"),use:n.attr("use"),encodingStyle:n.attr("encodingStyle"),namespace:n.attr("namespace")};o.faults.push(t)}),r.headers.push(o)}),r},e.prototype._parseHttpInputOrOutput=function(e){var r={urlEncoded:!!e.child("urlEncoded",t.NS.http),urlReplacement:!!e.child("urlReplacement",t.NS.http)};return r},e.prototype.parse=function(e){function r(e,t){for(var r={},n=0,o=t.length;o>n;++n)r[String(e(t[n]))]=t[n];return r}var o=this,a=Promise.resolve(this);if(this._parsed)return a;this._parsed=!0;var s=function(e){return e.map(function(e){return e.text().trim()}).join("\n").trim()};return this.resources[e].then(function(e){return n.Xml.fromString(e,t.NS.wsdl)}).then(function(e){var n=e.attr("targetNamespace");return o.messages=r(function(e){return e.name},e.children("message").map(function(e){return{name:e.resolveNS(e.attr("name"),n),parts:e.children("part").map(function(e){return{name:e.attr("name"),element:e.resolveNS(e.attr("element")),type:e.resolveNS(e.attr("type"),n)}})}})),o.portTypes=r(function(e){return e.name},e.children("portType").map(function(e){return{name:e.resolveNS(e.attr("name"),n),operations:r(function(e){return e.name},e.children("operation").map(function(e){return{name:e.resolveNS(e.attr("name"),n),description:s(e.children("documentation")),input:e.resolveNS(e.childOrEmpty("input").attr("message"),n),output:e.resolveNS(e.childOrEmpty("output").attr("message"),n)}}))}})),o.bindings=r(function(e){return e.name},e.children("binding").map(function(e){return{name:e.resolveNS(e.attr("name"),n),type:e.resolveNS(e.attr("type"),n),description:s(e.children("documentation")),operations:e.children("operation").map(function(r){return{name:r.resolveNS(r.attr("name"),e.resolveNS(e.attr("type"),n).namespace),description:s(r.children("documentation")),soap:r.children("operation",t.NS.soap).map(function(e){return{action:e.attr("soapAction"),style:e.attr("style")}})[0],soap12:r.children("operation",t.NS.soap12).map(function(e){return{action:e.attr("soapAction"),style:e.attr("style")}})[0],http:r.children("operation",t.NS.http).map(function(e){return{location:e.attr("location")}})[0],input:r.children("input").map(function(e){return{soap:o._parseSoapInputOrOutput(e,t.NS.soap),soap12:o._parseSoapInputOrOutput(e,t.NS.soap12),http:o._parseHttpInputOrOutput(e)}})[0],output:r.children("output").map(function(e){return{soap:o._parseSoapInputOrOutput(e,t.NS.soap),soap12:o._parseSoapInputOrOutput(e,t.NS.soap12),http:o._parseHttpInputOrOutput(e)}})[0]}}),soap:e.children("binding",t.NS.soap).map(function(e){return{transport:e.attr("transport"),style:e.attr("style")||"document"}})[0],soap12:e.children("binding",t.NS.soap12).map(function(e){return{style:e.attr("style")||"document"}})[0],http:e.children("binding",t.NS.http).map(function(e){return{verb:e.attr("verb")}})[0]}})),o.services=e.children("service").map(function(e){return{name:e.resolveNS(e.attr("name"),n),description:s(e.children("documentation")),ports:e.children("port").map(function(e){return{name:e.resolveNS(e.attr("name"),n),description:s(e.children("documentation")),binding:e.resolveNS(e.attr("binding"),n),address:null,soap:e.children("address",t.NS.soap).map(function(e){return{address:e.attr("location")}})[0],soap12:e.children("address",t.NS.soap12).map(function(e){return{address:e.attr("location")}})[0],http:e.children("address",t.NS.http).map(function(e){return{address:e.attr("location")}})[0]}})}}),o.schemas=e.children("types").map(function(e){return e.children("schema",t.NS.schema)})[0]||[],o.imports=e.children("import"),o.resolveWsdlImports(o.imports)}).then(function(e){return a})},e.prototype.resolveWsdlImports=function(t){var r=this,n=Promise.resolve(this);return t.forEach(function(t){var o=e.getDirectory(r.url),a=e.combineUrl(o,t.attr("location"));t.location=a,n=n.then(function(e){return r._ajax(a)}).then(function(t){return e.parse(a,t,!1,r.resources)}).then(function(e){for(name in e.messages)r.messages[name]=e.messages[name];for(name in e.portTypes)r.portTypes[name]=e.portTypes[name];for(name in e.bindings)r.bindings[name]=e.bindings[name];for(name in e.services)r.services[name]=e.services[name];for(var t=0,n=e.schemas.length;n>t;++t)r.schemas.push(e.schemas[t]);return r})}),n},e.format={xml:function(e){var t=e?(new XMLSerializer).serializeToString(e):"";return t=t.replace(/ xmlns="\0"/g,' xmlns=""'),r.xml(t)}},e}();t.WsdlDocument=d});